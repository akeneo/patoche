# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices/configuration.html#application-related-configuration
parameters:
    akeneo_patoche.application.mapped_branches:
        '1.2': '2.3'
        '2.0': '3.0'
        '2.1': '3.0'
        '2.2': '3.0'
    akeneo_patoche.infrastructure.default_filesystem.directory: '%kernel.project_dir%/data'
    akeneo_patoche.infrastructure.path_to_composer_executable: '%env(string:PATH_TO_COMPOSER_EXECUTABLE)%'
    akeneo_patoche.infrastructure.symfony_process.timeout: '%env(int:SYMFONY_PROCESS_TIMEOUT)%'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: false      # Automatically injects dependencies in your services.
        autoconfigure: false # Automatically registers your services as commands, event subscribers, etc.

    # Application handlers

    Akeneo\Patoche\Application\Deployment\PreparePimForDeploymentHandler:
        arguments:
            - '@Akeneo\Patoche\Application\Vcs\VcsApiClient'
            - '@Akeneo\Patoche\Application\Deployment\DependencyManagerFactory'

    Akeneo\Patoche\Application\Vcs\DownloadArchiveHandler:
        arguments:
            - '@Akeneo\Patoche\Application\Vcs\VcsApiClient'

    Akeneo\Patoche\Application\Vcs\GetNextTagHandler:
        arguments:
            - '@Akeneo\Patoche\Application\Vcs\VcsApiClient'

    # Application subscribers

    Akeneo\Patoche\Application\Deployment\Subscriber\PreparePimForDeploymentSubscriber:
        arguments:
            - '@Akeneo\Patoche\Application\Deployment\PreparePimForDeploymentHandler'
        tags: ['kernel.event_subscriber']

    Akeneo\Patoche\Application\Vcs\Subscriber\DownloadArchiveSubscriber:
        arguments:
            - '@Akeneo\Patoche\Application\Vcs\DownloadArchiveHandler'
        tags: ['kernel.event_subscriber']

    # Infrastructure services

    Akeneo\Patoche\Infrastructure\Deployment\DependencyManager\ComposerFactory:
        arguments:
            - '%akeneo_patoche.infrastructure.path_to_composer_executable%'
            - '%akeneo_patoche.infrastructure.default_filesystem.directory%'
            - '%akeneo_patoche.infrastructure.symfony_process.timeout%'
    Akeneo\Patoche\Application\Deployment\DependencyManagerFactory: '@Akeneo\Patoche\Infrastructure\Deployment\DependencyManager\ComposerFactory'

    Akeneo\Patoche\Infrastructure\Vcs\Api\GitHubClient:
        arguments:
            - '@Github\Client'
            - '@League\Flysystem\Filesystem'
            - '%akeneo_patoche.infrastructure.default_filesystem.directory%'
    Akeneo\Patoche\Application\Vcs\VcsApiClient: '@Akeneo\Patoche\Infrastructure\Vcs\Api\GitHubClient'

    # Symfony commands

    Akeneo\Patoche\Infrastructure\IO\CommandLine\OnboarderRelease:
        arguments:
            - '@Akeneo\Patoche\Application\Vcs\GetNextTagHandler'
            - '@workflow.onboarder_release'
            - '%akeneo_patoche.application.mapped_branches%'
        tags: ['console.command']
